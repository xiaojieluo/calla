<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="UTF-8">
    <title>llnhhy's Blog</title>
    <meta name="keywords" content="luoxiaojie blog" />
    <meta name="description" content="llnhhy's Blog | Web | python | Code | Computer Sciences" />
    <style type="text/css">
        .indexcolor,
        .willerce a {
            /*color: #ffffff !important;*/
        }
    </style>
    <style type="text/css" id="custom-background-css">
        body.custom-background {
            /*background-color: #0a0a0a;*/
            /*background-image: url("http://www.wpke.net/wp-content/uploads/2017/03/sdfgge.jpg");*/
            background-position: left top;
            background-size: auto;
            background-repeat: repeat;
            background-attachment: scroll;
        }
    </style>
    <link rel="icon" href="/theme/img/cropped-avatar-32x32.png" sizes="32x32" />
    <link rel="icon" href="/theme/img/cropped-avatar-192x192.png" sizes="192x192" />
    <link rel="apple-touch-icon-precomposed" href="/theme/img/cropped-avatar-180x180.png" />
    <meta name="msapplication-TileImage" content="/theme/img/cropped-avatar-270x270.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link href="//cdn.bootcss.com/highlight.js/9.12.0/styles/atom-one-light.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/theme/css/style.css">

    <script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
</head>

<body>
    <header class="mod-head">
        <h1 class="mod-head__title"><a href="http://www.llnhhy.com">Xiaojie Luo</a></h1>
        <div class="mod-head__logo">
            <a href="http://www.llnhhy.com" title="Xiaojie Luo"><img class="avatar" width="26" height="26" src="/theme/img/avatar.png"></a>
        </div>
        <nav class="mod-head__nav">
            <ul id="menu-%e8%8f%9c%e5%8d%951" class="mod-head__ul">
                    <li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-14"><a href="/">Home</a><span>·</span></li>
                    <li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-14"><a href="/archives.html">Archive</a></li>
            </ul>
        </nav>
        <a id="right-panel-link" href="#right-panel"><i class="iconfont icon-fenlei"></i></a>
        <div id="right-panel" class="panel">
            <h3 class="rightnavh3">Menu</h3>
            <ul id="menu-%e8%8f%9c%e5%8d%951-1" class="ymod-head">
                    <li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="{link[1]}">Home</a></li>
                    <li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="{link[1]}">Archive</a></li>
            </ul> <button id="close-panel-bt">X Close</button>
        </div>
        <script src="/theme/js/slider.js"></script>
        <script>
            $('#right-panel-link').panelslider({
                side: 'right',
                duration: 200
            });
            $('#close-panel-bt').click(function() {
                $.panelslider.close();
            });
        </script>
        <hr />
    </header>
        <article class="mod-post mod-post__type-post">
        <header>
            <h1 class="mod-post__title">简单理解Socket</h1>
        </header>
        <div class="mod-post__entry wzulli">
            <hr>
<h1>TCP/IP</h1>
<p>要想理解 socket 首先得熟悉一下 TCP/IP 协议族， TCP/IP（Transmission Control Protocol/Internet Protocol）即传输控制协议/网间协议，定义了主机如何连入因特网及数据如何再它们之间传输的标准，</p>
<p>从字面意思来看 TCP/IP 是 TCP 和 IP 协议的合称，但实际上 TCP/IP 协议是指因特网整个 TCP/IP 协议族。不同于 ISO 模型的七个分层，TCP/IP 协议参考模型把所有的 TCP/IP 系列协议归类到四个抽象层中</p>
<p>应用层：TFTP，HTTP，SNMP，FTP，SMTP，DNS，Telnet 等等</p>
<p>传输层：TCP，UDP</p>
<p>网络层：IP，ICMP，OSPF，EIGRP，IGMP</p>
<p>数据链路层：SLIP，CSLIP，PPP，MTU</p>
<p>每一抽象层建立在低一层提供的服务上，并且为高一层提供服务，看起来大概是这样子的:</p>
<p><img alt="socket 四层模型" src="./socket.jpg"></p>
<p><img alt="socket 详细四层模型图" src="./socket2.gif"></p>
<p>在 TCP/IP 协议中两个因特网主机通过两个路由器和对应的层连接。各主机上的应用通过一些数据通道相互执行读取操作。</p>
<p><img alt="Network" src="./network.png"></p>
<h1>Socket</h1>
<p>我们知道两个进程如果需要进行通讯最基本的一个前提能能够唯一的标示一个进程，在本地进程通讯中我们可以使用PID来唯一标示一个进程，但PID只在本地唯一，网络中的两个进程PID冲突几率很大，这时候我们需要另辟它径了，我们知道IP层的ip地址可以唯一标示主机，而TCP层协议和端口号可以唯一标示主机的一个进程，这样我们可以利用ip地址＋协议＋端口号唯一标示网络中的一个进程。</p>
<p>能够唯一标示网络中的进程后，它们就可以利用 socket 进行通信了，什么是 socket 呢？我们经常把 socket 翻译为套接字，socket 是在应用层和传输层之间的一个抽象层，它把 TCP/IP 层复杂的操作抽象为几个简单的接口供应用层调用已实现进程在网络中通信。</p>
<p><img alt="socket 协议" src="./socket3.jpg"></p>
<p>socket 起源于 UNIX，在 Unix 一切皆文件哲学的思想下，socket 是一种"打开—读/写—关闭"模式的实现，服务器和客户端各自维护一个"文件"，在建立连接打开后，可以向自己文件写入内容供对方读取或者读取对方内容，通讯结束时关闭文件。</p>
<h1>socket通信流程</h1>
<p>socket 是"打开—读/写—关闭"模式的实现，以使用 TCP 协议通讯的 socket 为例，其交互流程大概是这样子的</p>
<p><img alt="socket 交互流程" src="./socket4.png"></p>
<ul>
<li>服务器根据地址类型（ipv4,ipv6）、socket 类型、协议创建 socket</li>
<li>服务器为 socket 绑定ip地址和端口号</li>
<li>服务器 socket 监听端口号请求，随时准备接收客户端发来的连接，这时候服务器的 socket 并没有被打开</li>
<li>客户端创建 socket</li>
<li>客户端打开 socket，根据服务器ip地址和端口号试图连接服务器 socket</li>
<li>服务器 socket 接收到客户端 socket 请求，被动打开，开始接收客户端请求，直到客户端返回连接信息。这时候 socket进 入阻塞状态，所谓阻塞即 accept() 方法一直到客户端返回连接信息后才返回，开始接收下一个客户端谅解请求</li>
<li>客户端连接成功，向服务器发送连接状态信息</li>
<li>服务器 accept 方法返回，连接成功</li>
<li>客户端向 socket 写入信息</li>
<li>服务器读取信息</li>
<li>客户端关闭</li>
<li>服务器端关闭</li>
</ul>
<h1>三次握手</h1>
<p>在 TCP/IP 协议中，TCP 协议通过三次握手建立一个可靠的连接</p>
<p><img alt="TCP" src="./tcp.jpg"></p>
<ul>
<li>
<p>第一次握手：客户端尝试连接服务器，向服务器发送 syn 包（同步序列编号 Synchronize Sequence Numbers），syn=j，客户端进入 SYN_SEND 状态等待服务器确认</p>
</li>
<li>
<p>第二次握手：服务器接收客户端 syn 包并确认（ack=j+1），同时向客户端发送一个 SYN 包（syn=k），即 SYN+ACK 包，此时服务器进入 SYN_RECV状态</p>
</li>
<li>
<p>第三次握手：客户端收到服务器的 SYN+ACK 包，向服务器发送确认包ACK(ack=k+1），此包发送完毕，客户端和服务器进入 ESTABLISHED 状态，完成三次握手</p>
</li>
</ul>
<p>定睛一看，服务器 socket 与客户端 socket 建立连接的部分其实就是大名鼎鼎的三次握手</p>
<p><img alt="TCP" src="./tcp2.png"></p>
<p>参考</p>
<p><a href="http://www.cnblogs.com/skynet/archive/2010/12/12/1903949.html">Linux Socket编程（不限Linux）</a></p>
<p><a href="http://goodcandle.cnblogs.com/archive/2005/12/10/294652.aspx">揭开Socket编程的面纱</a></p>
        </div>
        <div class="mod-post__meta">
            <div>
                <div>— <span>Published Date: <time datetime="2017-26-Aug">2017-26-Aug</time></span>
                </div>
                <div>— Tags: <span class="mod_tag">
                    <a href="tag/socket.html" rel="tag">socket</a>
</span>
                </div>
            </div>
        </div>
    </article>
    <section class="mod-comment">
                <div style="text-align:center;">
                  <button class="load-disqus" id="load-disqus" onclick="disqus.load();">加载 Disqus 评论</button>
                </div>
                <div id="disqus_thread"></div>

        <div class="navigation">
            <div class="alignleft"></div>
            <div class="alignright"></div>
        </div>
        <!-- #respond -->
    </section>

    <footer class="mod-footer" role="contentinfo" id="footer_in">
            <hr />
            <div class="copyright">&copy; 2017-2018 Powered by <a href="https://blog.getpelican.com/" target="_blank">Pelican</a> Theme &copy; <a href="https://github.com/xiaojieluo" target="_blank">LuoXiaojie</a></div>
    </footer>
    <script>
        POWERMODE.colorful = true; // ture 为启用礼花特效
        POWERMODE.shake = false; // false 为禁用震动特效
        document.body.addEventListener('input', POWERMODE);
    </script>
    <script type='text/javascript' src='/theme/js/comment-reply.min.js?ver=4.8'></script>
    <script type='text/javascript' src='/theme/js/jquery.js?ver=1.12.4'></script>
    <script type='text/javascript' src='/theme/js/jquery-migrate.min.js?ver=1.4.1'></script>

    <script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
    <script type="text/javascript">
        $(document).ready(function() {
          $('.highlight').each(function(i, block) {
            hljs.highlightBlock(block);
          });
        });
    </script>

    <script>
    var disqus_config = function () {
            this.page.url = "http://www.llnhhy.com/posts/Simple_understanding_Socket.html    ";  // Replace PAGE_URL with your page's canonical URL variable
            this.page.identifier = "简单理解Socket"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    var disqus = {
      load : function disqus(){
          if(typeof DISQUS !== 'object') {
            (function() { // DON'T EDIT BELOW THIS LINE
            var d = document, s = d.createElement('script');
            s.src = 'https://llnhhy.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
            })();
            $('#load-disqus').remove(); ///加载后移除按钮
          }
      }
    }
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-92533917-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>

</html>