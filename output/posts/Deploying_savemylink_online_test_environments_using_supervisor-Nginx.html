<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="UTF-8">
    <title>llnhhy's Blog</title>
    <meta name="keywords" content="luoxiaojie blog" />
    <meta name="description" content="llnhhy's Blog | Web | python | Code | Computer Sciences" />
    <style type="text/css">
        .indexcolor,
        .willerce a {
            /*color: #ffffff !important;*/
        }
    </style>
    <style type="text/css" id="custom-background-css">
        body.custom-background {
            /*background-color: #0a0a0a;*/
            /*background-image: url("http://www.wpke.net/wp-content/uploads/2017/03/sdfgge.jpg");*/
            background-position: left top;
            background-size: auto;
            background-repeat: repeat;
            background-attachment: scroll;
        }
    </style>
    <link rel="icon" href="/theme/img/cropped-avatar-32x32.png" sizes="32x32" />
    <link rel="icon" href="/theme/img/cropped-avatar-192x192.png" sizes="192x192" />
    <link rel="apple-touch-icon-precomposed" href="/theme/img/cropped-avatar-180x180.png" />
    <meta name="msapplication-TileImage" content="/theme/img/cropped-avatar-270x270.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link href="//cdn.bootcss.com/highlight.js/9.12.0/styles/atom-one-light.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/theme/css/style.css">

    <script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
</head>

<body>
    <header class="mod-head">
        <h1 class="mod-head__title"><a href="http://www.llnhhy.com">Xiaojie Luo</a></h1>
        <div class="mod-head__logo">
            <a href="http://www.llnhhy.com" title="Xiaojie Luo"><img class="avatar" width="26" height="26" src="/theme/img/avatar.png"></a>
        </div>
        <nav class="mod-head__nav">
            <ul id="menu-%e8%8f%9c%e5%8d%951" class="mod-head__ul">
                    <li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-14"><a href="/">Home</a><span>·</span></li>
                    <li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-14"><a href="/archives.html">Archive</a></li>
            </ul>
        </nav>
        <a id="right-panel-link" href="#right-panel"><i class="iconfont icon-fenlei"></i></a>
        <div id="right-panel" class="panel">
            <h3 class="rightnavh3">Menu</h3>
            <ul id="menu-%e8%8f%9c%e5%8d%951-1" class="ymod-head">
                    <li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="{link[1]}">Home</a></li>
                    <li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="{link[1]}">Archive</a></li>
            </ul> <button id="close-panel-bt">X Close</button>
        </div>
        <script src="/theme/js/slider.js"></script>
        <script>
            $('#right-panel-link').panelslider({
                side: 'right',
                duration: 200
            });
            $('#close-panel-bt').click(function() {
                $.panelslider.close();
            });
        </script>
        <hr />
    </header>
        <article class="mod-post mod-post__type-post">
        <header>
            <h1 class="mod-post__title">使用supervisor-Nginx部署savemylink线上测试环境</h1>
        </header>
        <div class="mod-post__entry wzulli">
            <hr>
<p>经过了一个多月断断续续地开发，savemylink这个项目终于到了可以初步运行的地步，线上环境选择的方案就是使用
Nginx 来做反向代理，使用 Supervisord 来作为进程管理工具</p>
<h2>技术选择</h2>
<ul>
<li><a href="http://supervisord.org">Supervisor</a></li>
<li><a href="http://nginx.org/">Nginx</a></li>
</ul>
<h2>服务器</h2>
<p>服务器一开始使用的是 <a href="https://bwh1.net/">banwagong</a> 的vps，但是搭建了之后发现速度跟不上，后来就换到了 Linode ,现在线上测试环境是<a href="linode.com">Linode</a> 的 Forment 节点. 内存2G，用来测试应该足够了。</p>
<p>操作系统选择了 Centos 7</p>
<h2>Nginx</h2>
<h3>安装 Nginx</h3>
<p>运行下面命令安装nginx</p>
<div class="highlight"><pre><span></span>    sudo yum update -y
    sudo yum install epel-release
    sudo yum install nginx
</pre></div>


<h3>配置 Nginx</h3>
<p>Nginx 的配置文件可以参考 Tornado <a href="http://tornadocn.readthedocs.io/zh/latest/guide/running.html">文档最后的例子</a> ,基本就是那样，只有一些地方按照自己的目录修改下就可以了
修改完成之后启动Nginx并添加到开机启动列表中</p>
<div class="highlight"><pre><span></span>    sudo systemctl restart nginx
    sudo systemctl <span class="nb">enable</span> nginx
</pre></div>


<p>Nginx 配置结束了，下面来配置supervisor</p>
<h2>supervisor</h2>
<p><a href="http://supervisord.org">Supervisor</a> 是一个用 Python
编写的进程管理工具，可以很方便的用来启动、重启、关闭进程（不仅仅是 Python 进程）。除了对单个进程的控制，还可以同时启动、关闭多个进程，比如很不幸的服务器出问题导致所有应用程序都被杀死，此时可以用
supervisor 同时启动所有应用程序而不是一个一个地敲命令启动。</p>
<h3>安装</h3>
<p>Supervisor 可以运行在 Linux、Mac OS X 上。如前所述，supervisor 是 Python
编写的，所以安装起来也很方便，可以直接用 pip (若使用python3，需运行pip3
来安装):</p>
<div class="highlight"><pre><span></span>    sudo pip install supervisor
</pre></div>


<h3>配置</h3>
<p>在上面的 <code>nginx.conf</code> 中，我们开了四个 Tornado 进程，端口号分别是 8000, 8001, 8002, 8003，现在来看 supervisor 的配置，其他配置可以自行 Google ,这里来看下与端口有关的配置</p>
<p>开了四个 Tornado 进程，需要使用来 supervisor 来管理，于是和端口有关的配置如下：</p>
<p>先将默认的 supervisor 配置写入 /etc/supervisor.conf 中，运行下面命令：</p>
<div class="highlight"><pre><span></span>    supervisor
</pre></div>


<p>然后我们要新建几个配置文件，用来启动 Tornado 进程，
在 <code>/etc/supervisor.d/</code> 目录下新建五个文件(注意最后的 redis-6379，因为我项目中用到了 Redis ,所以要加上 Redis 配置文件)：</p>
<div class="highlight"><pre><span></span>    tornado-8000.supervisor
    tornado-8001.supervisor
    tornado-8002.supervisor
    tornado-8003.supervisor
    redis-6379.supervisor
</pre></div>


<p>文件内容如下：</p>
<p><strong>tornado-8000.supervisor</strong></p>
<div class="highlight"><pre><span></span>    [program:tornado-8000]
    command=python3 /home/blog/app/app.py --port=8000
    autostart=true                ; supervisord守护程序启动时自动启动tornado
    autorestart=true              ; supervisord守护程序重启时自动重启tornado
    redirect_stderr=true          ; 将stderr重定向到stdout
    stdout_logfile = /home/blog/blog-8000.log
</pre></div>


<p><strong>tornado-8001.supervisor</strong></p>
<div class="highlight"><pre><span></span>    <span class="o">[</span>program:tornado-8001<span class="o">]</span>
    <span class="nv">command</span><span class="o">=</span>python3 /home/blog/app/app.py --port<span class="o">=</span><span class="m">8001</span>
    <span class="nv">autostart</span><span class="o">=</span><span class="nb">true</span>                <span class="p">;</span> supervisord守护程序启动时自动启动tornado
    <span class="nv">autorestart</span><span class="o">=</span><span class="nb">true</span>              <span class="p">;</span> supervisord守护程序重启时自动重启tornado
    <span class="nv">redirect_stderr</span><span class="o">=</span><span class="nb">true</span>          <span class="p">;</span> 将stderr重定向到stdout
    <span class="nv">stdout_logfile</span> <span class="o">=</span> /home/blog/blog-8001.log
</pre></div>


<p><strong>tornado-8002.supervisor</strong></p>
<div class="highlight"><pre><span></span>    <span class="o">[</span>program:tornado-8002<span class="o">]</span>
    <span class="nv">command</span><span class="o">=</span>python3 /home/blog/app/app.py --port<span class="o">=</span><span class="m">8002</span>
    <span class="nv">autostart</span><span class="o">=</span><span class="nb">true</span>                <span class="p">;</span> supervisord守护程序启动时自动启动tornado
    <span class="nv">autorestart</span><span class="o">=</span><span class="nb">true</span>              <span class="p">;</span> supervisord守护程序重启时自动重启tornado
    <span class="nv">redirect_stderr</span><span class="o">=</span><span class="nb">true</span>          <span class="p">;</span> 将stderr重定向到stdout
    <span class="nv">stdout_logfile</span> <span class="o">=</span> /home/blog/blog-8002.log
</pre></div>


<p><strong>tornado-8003.supervisor</strong></p>
<div class="highlight"><pre><span></span>    <span class="o">[</span>program:tornado-8003<span class="o">]</span>
    <span class="nv">command</span><span class="o">=</span>python3 /home/blog/app/app.py --port<span class="o">=</span><span class="m">8003</span>
    <span class="nv">autostart</span><span class="o">=</span><span class="nb">true</span>                <span class="p">;</span> supervisord守护程序启动时自动启动tornado
    <span class="nv">autorestart</span><span class="o">=</span><span class="nb">true</span>              <span class="p">;</span> supervisord守护程序重启时自动重启tornado
    <span class="nv">redirect_stderr</span><span class="o">=</span><span class="nb">true</span>          <span class="p">;</span> 将stderr重定向到stdout
    <span class="nv">stdout_logfile</span> <span class="o">=</span> /home/blog/blog-8003.log
</pre></div>


<p><strong>redis-6379.supervisord</strong></p>
<div class="highlight"><pre><span></span>    <span class="o">[</span>program:redis-6379<span class="o">]</span>
    <span class="nb">command</span> <span class="o">=</span> /usr/local/bin/redis-server /var/www/savemylink/redis.conf  <span class="p">;</span> 启动命令，可以看出与手动在命令行启动的命令是一样的
    <span class="nv">autostart</span> <span class="o">=</span> <span class="nb">true</span>     <span class="p">;</span> 在 supervisord 启动的时候也自动启动
    <span class="nv">autorestart</span> <span class="o">=</span> <span class="nb">true</span>   <span class="p">;</span> 程序异常退出后自动重启
    <span class="nv">startsecs</span> <span class="o">=</span> <span class="m">5</span>        <span class="p">;</span> 启动 <span class="m">5</span> 秒后没有异常退出，就当作已经正常启动了
    <span class="nv">startretries</span> <span class="o">=</span> <span class="m">3</span>     <span class="p">;</span> 启动失败自动重试次数，默认是 <span class="m">3</span>
    <span class="nv">redirect_stderr</span> <span class="o">=</span> <span class="nb">true</span>  <span class="p">;</span> 把 stderr 重定向到 stdout，默认 <span class="nb">false</span>
    <span class="nv">stdout_logfile_maxbytes</span> <span class="o">=</span> 20MB  <span class="p">;</span> stdout 日志文件大小，默认 50MB
    <span class="nv">stdout_logfile_backups</span> <span class="o">=</span> <span class="m">20</span>     <span class="p">;</span> stdout 日志文件备份数
    <span class="p">;</span> stdout 日志文件，需要注意当指定目录不存在时无法正常启动，所以需要手动创建目录（supervisord 会自动创建日志文件）
    <span class="nv">stdout_logfile</span> <span class="o">=</span> /var/www/savemylink/redis-6379-stdout.log
</pre></div>


<p>配置文件写入完成之后，还需要在 <code>/etc/supervisor.conf</code> 中 include
打开 <code>/etc/supervisor.conf</code> ,在最后添加下面代码：</p>
<div class="highlight"><pre><span></span>    <span class="o">[</span>include<span class="o">]</span>
    <span class="nv">files</span><span class="o">=</span>/etc/supervisor.d/*.supervisor
</pre></div>


<h3>supervisorctl 操作</h3>
<p>Supervisorctl 是 supervisord 的一个命令行客户端工具，启动时需要指定与 supervisord 使用同一份配置文件，否则与 supervisord 一样按照顺序查找配置文件。</p>
<p>在命令后运行 <code>supervisorctl</code> ，可以进入 supervisor 的命令行模式，在此模式中支持以下几种操作命令：</p>
<ul>
<li>status : 查看被管理的进程的状态</li>
<li>start : 启动指定进程</li>
<li>stop : 停止指定进程</li>
<li>restart : 重启指定进程</li>
<li>update : 启动新配置或有改动的进程</li>
<li>reload : 重新启动supervisor</li>
</ul>
<h3>supervisor 运行</h3>
<p>直接在命令行输入 <code>supervisord</code> 即可启动，可进入 supervisorctl` 检查各进程是否启动成功。</p>
<h2>结束</h2>
<p>使用浏览器访问地址就发现Nginx已经反向代理了Tornado进程，线上测试环境部署完成。</p>
        </div>
        <div class="mod-post__meta">
            <div>
                <div>— <span>Published Date: <time datetime="2017-06-Jun">2017-06-Jun</time></span>
                </div>
                <div>— Tags: <span class="mod_tag">
                    <a href="tag/supervisor.html" rel="tag">supervisor</a>
                    <a href="tag/nginx.html" rel="tag">nginx</a>
</span>
                </div>
            </div>
        </div>
    </article>
    <section class="mod-comment">
                <div style="text-align:center;">
                  <button class="load-disqus" id="load-disqus" onclick="disqus.load();">加载 Disqus 评论</button>
                </div>
                <div id="disqus_thread"></div>

        <div class="navigation">
            <div class="alignleft"></div>
            <div class="alignright"></div>
        </div>
        <!-- #respond -->
    </section>

    <footer class="mod-footer" role="contentinfo" id="footer_in">
            <hr />
            <div class="copyright">&copy; 2017-2018 Powered by <a href="https://blog.getpelican.com/" target="_blank">Pelican</a> Theme &copy; <a href="https://github.com/xiaojieluo" target="_blank">LuoXiaojie</a></div>
    </footer>
    <script>
        POWERMODE.colorful = true; // ture 为启用礼花特效
        POWERMODE.shake = false; // false 为禁用震动特效
        document.body.addEventListener('input', POWERMODE);
    </script>
    <script type='text/javascript' src='/theme/js/comment-reply.min.js?ver=4.8'></script>
    <script type='text/javascript' src='/theme/js/jquery.js?ver=1.12.4'></script>
    <script type='text/javascript' src='/theme/js/jquery-migrate.min.js?ver=1.4.1'></script>

    <script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
    <script type="text/javascript">
        $(document).ready(function() {
          $('.highlight').each(function(i, block) {
            hljs.highlightBlock(block);
          });
        });
    </script>

    <script>
    var disqus_config = function () {
            this.page.url = "http://www.llnhhy.com/posts/Deploying_savemylink_online_test_environments_using_supervisor-Nginx.html    ";  // Replace PAGE_URL with your page's canonical URL variable
            this.page.identifier = "使用supervisor-Nginx部署savemylink线上测试环境"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    var disqus = {
      load : function disqus(){
          if(typeof DISQUS !== 'object') {
            (function() { // DON'T EDIT BELOW THIS LINE
            var d = document, s = d.createElement('script');
            s.src = 'https://llnhhy.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
            })();
            $('#load-disqus').remove(); ///加载后移除按钮
          }
      }
    }
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-92533917-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>

</html>